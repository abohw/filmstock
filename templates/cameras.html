{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Search for Used Film Cameras{% endblock %}

{% block content %}

    {% load query_parameters %}
    {% del_query_parameters page as=clean_filters %}

    {% if user.is_authenticated == False %}
    <div class="container-lg" style="margin-top: 10px; margin-bottom: 10px; background-color: #dfe4ea; padding: 25px;">
      <div class="row align-items-center justify-content-center">
        <div class="col-auto me-auto">

          <h1>Welcome to Filmstock.</h1>

          <p></p>

          <p>Filmstock checks the inventory of <b>vintage film cameras</b> from around the US.</p>

          <p>Find the elusive camera you've been longing after:
            <ul>
              <li>Create and save customized searches</li>
              <li>Check current inventory</li>
              <li>Be alerted as soon as new cameras are stocked</li>
              </ul>
              </p>

          <p>Filmstock is currently in public beta. Learn more in our <a class="link" href="{% url 'help' %}">FAQ</a>.</p>

          <p>To get started, <a class="link" href="{% url 'signup' %}">create an account</a> or start your search below.</p>

        </div>
        <div class="col-auto">
          <img src="{% static 'img/home.png' %}" loading="lazy" class="img-fluid mx-auto d-block" alt="Filmstock" style="max-height: 250px">
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row justify-content-between">

      <div class="col-md-2 ms-auto" style="margin-top:10px;">

        {% if user.is_authenticated and user.searches.all %}
          <div class="dropdown">
            <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
              Saved searches
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              {% for search in user.searches.all %}
              <li><a class="dropdown-item" href="/?{{ search.url }}">{{ search.name|truncatechars:25 }}</a></li>
              {% endfor %}
            </ul>
          </div>

          <p></p>
        {% endif %}

        <form action="" method="get">
          {{ cameras.form|crispy }}
          <div class="d-grid gap-2">
            <input class="btn btn-primary btn-sm" type="submit" value="Submit">
          </div>
        </form>

        {% if user.is_authenticated %}

        <p></p>

        <div class="d-grid gap-2">
          <a class="btn btn-secondary btn-sm" href="{% if clean_filters %}{% url 'save-search' %}?{{ clean_filters }}{% endif %}" role="button">Save this search</a>
        </div>

        {% else %}

        <p></p>

        <div class="d-grid gap-2">
          <a class="btn btn-secondary btn-sm" href="{% url 'signup' %}?from=savesearch" role="button">Save this search</a>
        </div>

        {% endif %}

      </div>

      <div class="col-md-10">

        <div class="table-responsive">

        <table class="table">

          <thead>
            <th scope="col" width="60%">Camera</th>
            <th scope="col">Price</th>
            <th scope="col">Source</th>
            <th scope="col">Added</th>
          </thead>

          <tbody>

          {% for camera in page_obj %}

            <tr>
              <td>
                <a class="link" href="{{ camera.url }}" target="_blank">{{ camera.name|truncatechars:70 }}</a>
                {% now "Y-m-d" as today %}
                {% if today == camera.createdAt|date:"Y-m-d" %}
                &nbsp;<span class="badge bg-info text-dark">New</span>
                {% endif %}
              </td>
              <td>${{ camera.price }}</td>
              <td class="text-break">
                {% if camera.source == 'precision' %}
                  Precision Camera
                {% elif camera.source == 'bh' %}
                  B&H
                {% elif camera.source == 'austin_camera' %}
                  Austin Camera
                {% elif camera.source == 'keh' %}
                  KEH Camera
                {% elif camera.source == 'etsy' %}
                  Etsy ({{ camera.store }})
                {% else %}
                  {{ camera.source }}
                {% endif %}
              </td>
              <td>
                {{ camera.createdAt|date:'N j, Y' }}
              </td>
            </tr>

          {% endfor %}

          </tbody>
        </table>

        </div>

        <p></p>

        <nav>
          <ul class="pagination pagination-sm flex-wrap justify-content-start">
            {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{% if clean_filters %}{{ clean_filters }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1" aria-disabled="true" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            {% endif %}
            {% for page in page_obj.paginator.page_range %}
              {% if page == page_obj.number %}
              <li class="page-item active" aria-current="page">
                <span class="page-link">{{ page }}</span>
              </li>
              {% else %}
              <li class="page-item"><a class="page-link" href="?{% if clean_filters %}{{ clean_filters }}&{% endif %}page={{ page }}">
               {{ page }}</a></li>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{% if clean_filters %}{{ clean_filters }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1" aria-disabled="true" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>

        <p class="text-start">
          {{ cameras.qs.count }} cameras in results ({{ total }} available)
          {% if request.GET.name is not None %}
          <br>
          Can't find anything? Try searching <a class="link" href="{{ reddit_url }}" target="_blank">Reddit</a> or <a class="link" href="{{ ebay_url }}" target="_blank">eBay</a>
          {% endif %}
        </p>

    </div>

  </div>

{% endblock %}
